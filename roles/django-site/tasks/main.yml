---
- name: Create django group
  group:
    name=django
    system=yes
    state=present

- name: Create django user
  user:
    name=django
    append=yes
    group=django
    home={{ django_site_root }}
    shell=/bin/bash
    system=yes
    state=present

- name: Ensure django-site directory exists
  file:
    path={{ django_site_root | mandatory }}
    state=directory
    owner=django
    group=django
    mode=02775

- name: Ensure django-site htdocs directory exists
  file:
    path={{ django_site_root }}/htdocs
    state=directory
    owner=django
    group=django
    mode=02775

- name: Generate Google site verification file
  copy:
    dest: '{{ django_site_root }}/htdocs/google{{ google_site_verification_code }}.html'
    content: 'google-site-verification: google{{ google_site_verification_code }}.html'
    owner: django
    group: django
    mode: 0644
  when: google_site_verification_code is defined

- name: Link media dir
  file:
    src=static/media
    dest={{ django_site_root | mandatory }}/media
    force=yes
    state=link

- name: Repo-init the django manifest
  command: repo init -u {{ django_site_manifest_url | mandatory }}
    creates={{ django_site_root }}/.repo/manifest.xml
    chdir={{ django_site_root }}

- name: Repo-sync the latest source tree
  command: repo sync
    chdir={{ django_site_root }}

- name: Ensure dependencies are installed.
  apt: pkg=make state=installed

- include: postgresql.yml

- name: Generate settings_local.py
  template: >
    src=django/settings_local.py.j2
    dest={{ django_site_root }}/site/project/settings_local.py
    owner=django
    group=django
    mode=0600

- name: Prepare database schema
  command: make prepare-db
    chdir={{ django_site_root }}/site
  environment:
    DJANGO_SETTINGS_MODULE: project.settings_local

- name: Touch wsgi.py
  file:
    path={{ django_site_root }}/site/project/wsgi.py state=touch
