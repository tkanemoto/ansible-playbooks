---
hostname: tkanemoto.com
hostname_short: '{{ hostname | regex_replace("\..*$", "") }}'
allowed_csp_domains:
  - 'https://www.instagram.com'
  - 'https://fonts.gstatic.com'
  - 'https://www.google-analytics.com'
  - 'https://www.googletagmanager.com'
  - 'https://cdnjs.cloudflare.com'
  - 'https://www.google.com'
  - 'https://www.gstatic.com'
  - 'https://platform.twitter.com'
  - 'https://syndication.twitter.com'
  - 'https://platform.linkedin.com'
  - 'https://connect.facebook.net'
  - 'https://snap.licdn.com'
  - 'https://static.ads-twitter.com'
  - 'https://px.ads.linkedin.com'
  - 'https://analytics.twitter.com'
  - 'https://www.linkedin.com'
  - 'https://www.henrisalonen.com'

apache_global_vhost_settings: |
  DirectoryIndex index.php index.html
  LogLevel warn
  #LogFormat "%v:%p %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D %B" {{ hostname_short }}_access
  #LogFormat "%v:%p %h %l %u %t \"%r\" %>s %D \"%{Referer}i\" \"%{User-Agent}i\"" {{ hostname_short }}_access
  #CustomLog /var/log/apache2/{{ hostname }}_access.log {{ hostname_short }}_access
  ErrorLog /var/log/apache2/error.log

django_site_root: /var/www/django-site
django_site_manifest_url: https://github.com/tkanemoto/django-manifest.git
django_database_db: django
django_database_username: django

apache_remove_default_vhost: true
#apache_vhosts_filename: '000-vhosts.conf'
apache_create_vhosts: false
apache_mods_enabled:
  - rewrite.load
  - proxy.load
  - proxy_http.load
  - proxy_wstunnel.load
  - wsgi.load
  - headers.load
  - reqtimeout.load
  - ssl.load
  - php7.2.load
apache_packages:
  - apache2
  - apache2-utils
  - apache2-dev
  - libapache2-mod-php

apache_vhosts:
  - servername: 'apps.{{ hostname }}'
    documentroot: '{{ django_site_root }}/htdocs'
    extra_parameters: |
      RewriteEngine on
      RewriteRule ^/review/(.*)$ https://review.%{SERVER_NAME}/$1 [R=301,L]
      RewriteRule ^/ci/(.*)$ https://ci.%{SERVER_NAME}/$1 [R=301,L]
      RewriteRule ^/?(.*)$ https://%{SERVER_NAME}/$1 [R=301,L]

  - servername: 'tkanemoto-review.ddns.net'
    documentroot: '{{ django_site_root }}/htdocs'
    extra_parameters: |
      RewriteEngine on
      RewriteCond %{HTTP_USER_AGENT}  ^curl/.*
      RewriteRule ^/review/a/projects/ota-packages/branches/master/files/ota.sh/content https://{{ hostname }}/static/public/ota.sh [R=301,L]
      RewriteRule ^/?(.*)$ https://review.{{ hostname }}/$1 [R=301,L]

  - servername: 'tkanemoto.ddns.net'
    documentroot: '{{ django_site_root }}/htdocs'
    extra_parameters: |
      RewriteEngine on
      RewriteCond %{HTTP_USER_AGENT}  ^curl/.*
      RewriteRule ^/review/a/projects/ota-packages/branches/master/files/ota.sh/content https://{{ hostname }}/static/public/ota.sh [R=301,L]
      RewriteRule ^/?(.*)$ https://{{ hostname }}/$1 [R=301,L]

apache_vhosts_ssl:
  - servername: 'apps.{{ hostname }}'
    documentroot: '{{ django_site_root }}/htdocs'
    certificate_file: '/etc/letsencrypt/live/apps.{{ hostname }}/cert.pem'
    certificate_key_file: '/etc/letsencrypt/live/apps.{{ hostname }}/privkey.pem'
    certificate_chain_file: '/etc/letsencrypt/live/apps.{{ hostname }}/fullchain.pem'
    extra_parameters: |
      Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
      RequestReadTimeout header=90,MinRate=500 body=90,MinRate=500
      WSGIDaemonProcess django \
        user=django \
        group=django \
        processes=1 \
        threads=15 \
        display-name=%{GROUP} \
        python-home={{ django_site_root }}/.virtualenv \
        python-path={{ django_site_root }}/site
      WSGIProcessGroup django
      WSGIScriptAlias / {{ django_site_root }}/site/project/wsgi.py process-group=django

      RewriteEngine on
      RewriteRule ^/review/(.*)$ https://review.%{SERVER_NAME}/$1 [R=301,L]
      RewriteRule ^/ci/(.*)$ https://ci.%{SERVER_NAME}/$1 [R=301,L]

      Alias /static/ {{ django_site_root }}/static/
      <Directory "{{ django_site_root }}/static">
        AllowOverride All
        Options +Indexes +FollowSymLinks
        Require all granted
        Header set Access-Control-Allow-Origin "*"
      </Directory>

      Alias /media/ {{ django_site_root }}/static/media/
      Alias /google{{ google_site_verification_code }}.html {{ django_site_root }}/htdocs/google{{ google_site_verification_code }}.html

      RewriteCond %{HTTP:Upgrade} =websocket [NC]
      RewriteRule /(.*)           ws://localhost:9876/$1 [P,L]

      OIDCProviderIssuer https://tkanemoto.cloudflareaccess.com/
      OIDCProviderAuthorizationEndpoint https://tkanemoto.cloudflareaccess.com/
      OIDCClientID id
      OIDCClientSecret s3cr1t
      OIDCRedirectURI https://apps.{{ hostname }}/
      OIDCCryptoPassphrase {{ oidc_crypto_passphrase }}
      OIDCOAuthVerifyJwksUri https://tkanemoto.cloudflareaccess.com/cdn-cgi/access/certs
      OIDCOAuthRemoteUserClaim sub ^(.*)$ cf-access-$1
      OIDCOAuthAcceptTokenAs cookie:CF_Authorization
      <Location />
        AuthType oauth20
        Require valid-user
      </Location>
      {{ apache_extra_parameters }}

  - servername: 'ci.{{ hostname }}'
    documentroot: '{{ django_site_root }}/htdocs'
    certificate_file: '/etc/letsencrypt/live/ci.{{ hostname }}/cert.pem'
    certificate_key_file: '/etc/letsencrypt/live/ci.{{ hostname }}/privkey.pem'
    certificate_chain_file: '/etc/letsencrypt/live/ci.{{ hostname }}/fullchain.pem'
    extra_parameters: |
      LimitRequestFieldSize 32760
      LimitRequestLine 32760
      Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
      Header set Content-Security-Policy "script-src 'self' 'unsafe-inline' 'unsafe-eval' {{ allowed_csp_domains | join(' ') }}"
      ProxyPreserveHost On
      ProxyRequests     Off
      AllowEncodedSlashes NoDecode

      OIDCProviderIssuer https://tkanemoto.cloudflareaccess.com/
      OIDCProviderAuthorizationEndpoint https://tkanemoto.cloudflareaccess.com/
      OIDCClientID id
      OIDCClientSecret s3cr1t
      OIDCRedirectURI https://ci.{{ hostname }}/
      OIDCCryptoPassphrase {{ oidc_crypto_passphrase }}
      OIDCOAuthVerifyJwksUri https://tkanemoto.cloudflareaccess.com/cdn-cgi/access/certs
      OIDCOAuthRemoteUserClaim sub ^(.*)$ cf-access-$1
      OIDCOAuthAcceptTokenAs cookie:CF_Authorization

      <Proxy *>
        AuthType oauth20
        Require valid-user
        RequestHeader unset X-Forwarded-User
        RewriteEngine On
        RewriteCond %{LA-U:REMOTE_USER} (.+)
        RewriteRule .* - [E=RU:%1]
        RequestHeader set X-Forwarded-User %{RU}e
      </Proxy>

      ProxyPass / http://{{ groups['jenkins'][0] }}:{{ jenkins_http_port }}/ nocanon
      ProxyPassReverse / http://{{ groups['jenkins'][0] }}:{{ jenkins_http_port }}/

  - servername: 'review.{{ hostname }}'
    documentroot: '{{ django_site_root }}/htdocs'
    certificate_file: '/etc/letsencrypt/live/review.{{ hostname }}/cert.pem'
    certificate_key_file: '/etc/letsencrypt/live/review.{{ hostname }}/privkey.pem'
    certificate_chain_file: '/etc/letsencrypt/live/review.{{ hostname }}/fullchain.pem'
    extra_parameters: |
      Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
      #Alias /clone-bundles {{ django_site_root }}/htdocs/clone-bundles
      #RewriteEngine on
      #RewriteRule ^/a/(.*)\.git/clone.bundle$ https://{{ hostname }}/static/public/clone-bundles/$1.git/clone.bundle [R=301,L]
      #RewriteRule ^/a/(.*)/clone.bundle$ https://{{ hostname }}/static/public/clone-bundles/$1.git/clone.bundle [R=301,L]

      OIDCProviderIssuer https://tkanemoto.cloudflareaccess.com/
      OIDCProviderAuthorizationEndpoint https://tkanemoto.cloudflareaccess.com/
      OIDCClientID id
      OIDCClientSecret s3cr1t
      OIDCRedirectURI https://review.{{ hostname }}/
      OIDCCryptoPassphrase {{ oidc_crypto_passphrase }}
      OIDCOAuthVerifyJwksUri https://tkanemoto.cloudflareaccess.com/cdn-cgi/access/certs
      OIDCOAuthRemoteUserClaim sub ^(.*)$ cf-access-$1
      OIDCOAuthAcceptTokenAs cookie:CF_Authorization
      <Location />
        AuthType oauth20
        Require valid-user
        RequestHeader unset REMOTE_USER
        RewriteEngine On
        RewriteCond %{LA-U:REMOTE_USER} (.+)
        RewriteRule .* - [E=RU:%1]
        RequestHeader set REMOTE_USER %{RU}e
      </Location>

      ProxyPreserveHost On
      ProxyRequests     Off
      #ProxyVia Off
      AllowEncodedSlashes NoDecode
      ProxyPass / http://{{ groups['gerrit'][0] }}:8081/ nocanon
      ProxyPassReverse / http://{{ groups['gerrit'][0] }}:8081/

  # - servername: 'files.{{ hostname }}'
  #   documentroot: '/var/www/owncloud'
  #   certificate_file: '/etc/letsencrypt/live/files.{{ hostname }}/cert.pem'
  #   certificate_key_file: '/etc/letsencrypt/live/files.{{ hostname }}/privkey.pem'
  #   certificate_chain_file: '/etc/letsencrypt/live/files.{{ hostname }}/fullchain.pem'
  #   extra_parameters: |
  #     Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"

  - servername: 'source.{{ hostname }}'
    documentroot: '{{ django_site_root }}/htdocs'
    certificate_file: '/etc/letsencrypt/live/source.{{ hostname }}/cert.pem'
    certificate_key_file: '/etc/letsencrypt/live/source.{{ hostname }}/privkey.pem'
    certificate_chain_file: '/etc/letsencrypt/live/source.{{ hostname }}/fullchain.pem'
    extra_parameters: |
      Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
      ProxyPass /xref http://127.0.0.1:8080/xref nocanon
      ProxyPassReverse /xref http://127.0.0.1:8080/xref
      <Location />
        AuthType Basic
        AuthName "Restricted"
        AuthBasicProvider file
        AuthUserFile "{{ django_site_root }}/htpasswd"
        Require valid-user
      </Location>

  - servername: 'updates.{{ hostname }}'
    documentroot: '{{ django_site_root }}/htdocs'
    certificate_file: '/etc/letsencrypt/live/updates.{{ hostname }}/cert.pem'
    certificate_key_file: '/etc/letsencrypt/live/updates.{{ hostname }}/privkey.pem'
    certificate_chain_file: '/etc/letsencrypt/live/updates.{{ hostname }}/fullchain.pem'
    extra_parameters: |
      Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
      {{ updates_apache_config }}
